<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>诺贝尔奖获奖者发文量可视化</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            background: #000;
            margin: 0;
            overflow-y: auto;
            font-family: 'Orbitron', sans-serif;
            color: #ffffff;
        }
        .controls {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border: none;
            border-radius: 8px;
            color: #ffcc00;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }
        .legend-item {
            display: flex;
            align-items: center;
            padding: 5px 10px;
            border: 1px solid #ffffff;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .legend-item.selected {
            border: 2px solid #ffffff;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
        }
        .legend-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border-radius: 4px;
        }
        .legend-label {
            font-size: 14px;
            font-weight: 700;
            text-shadow: 0 0 3px rgba(255, 204, 0, 0.5);
        }
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: #ffcc00;
            padding: 8px 12px;
            border: 1px solid #ffcc00;
            border-radius: 5px;
            pointer-events: none;
            font-size: 12px;
            text-shadow: 0 0 3px rgba(255, 204, 0, 0.5);
            font-family: 'Times New Roman', '微软雅黑', 'Microsoft YaHei', Times, serif;
            z-index: 2000;
        }
        .overview {
            position: absolute;
            left: 300px;
            top: 70px;
            width: 50%;
            padding-bottom: 20px;
        }
        .year-title {
            font-size: 20px;
            font-family: 'Microsoft YaHei', 'Heiti SC', '黑体', Arial, sans-serif;
            color: #ffffff;
            fill: #ffffff;
            font-weight: bold;
        }
        svg {
            overflow: visible;
        }
        .year-svg {
            width: 100%;
            height: auto;
        }
        .year-svg .bar {
            cursor: pointer;
            opacity: 0.5;
        }
        .year-svg .bar:hover {
            opacity: 0.8;
        }
        .label {
            white-space: normal;
        }
        .detail {
            position: fixed;
            right: -800px;  /* 初始隐藏位置 */
            top: 0;
            width: 500px;   /* 边栏总宽度 */
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            flex-direction: column;
            align-items: flex-start;  /* 改为左对齐 */
            padding: 80px 40px 40px;  /* 上、右、下、左内边距 */
            transition: right 0.5s ease;
            z-index: 1000;
            border-left: 2px solid #ffcc00;
            overflow-y: auto;  /* 添加滚动条 */
        }
        .detail.active {
            display: flex;
            right: 0;
        }
        .detail-svg {
            width: 90%;
            height: 80vh;  /* 使用视口高度百分比 */
            margin-top: 20px;  /* 添加顶部外边距 */
        }
        .detail-svg .axis text {
            font-family: 'Times New Roman', '微软雅黑', 'Microsoft YaHei', Times, serif;
            font-size: 14px;
            fill: #ffffff;
        }
        .close-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: transparent;
            color: #ffcc00;
            border: 2px solid #ffcc00;
            padding: 5px 10px;
            border-radius: 50%;
            font-size: 20px;
            font-family: 'Orbitron', sans-serif;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-button:hover {
            background: #ffcc00;
            color: #000;
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <div class="controls">
        <div class="legend-item selected" data-field="physics">
            <span class="legend-color" style="background: #00ccff;"></span>
            <span class="legend-label">物理</span>
        </div>
        <div class="legend-item selected" data-field="chemistry">
            <span class="legend-color" style="background: #ffcc00;"></span>
            <span class="legend-label">化学</span>
        </div>
        <div class="legend-item selected" data-field="medicine">
            <span class="legend-color" style="background: #ff6666;"></span>
            <span class="legend-label">医学</span>
        </div>
    </div>
    <div class="tooltip" style="display: none;"></div>
    <div class="overview" id="overview">
    </div>
    <div class="detail" id="detail">
        <button class="close-button" id="close-button">×</button>
        <svg id="detail-svg" class="detail-svg"></svg>
    </div>
    <script>
        // 全局变量
        let selectedFields = ['chemistry', 'physics', 'medicine'];
        let allData = [];
        let timelineData = [];

        // 加载数据
        Promise.all([
            d3.json("scientist_data.json"),
            d3.json("scientist_timeline.json")
        ]).then(([scientists, timeline]) => {
            allData = scientists.data || scientists; // 如果数据嵌套，提取正确字段
            timelineData = timeline;
            updateOverview();
        }).catch(error => {
            console.error("数据加载失败:", error);
        });

        // 领域选择事件
        d3.selectAll(".legend-item").on("click", function() {
            const field = d3.select(this).attr("data-field");
            const isSelected = d3.select(this).classed("selected");
            d3.select(this).classed("selected", !isSelected);
            
            if (isSelected) {
                selectedFields = selectedFields.filter(f => f !== field);
            } else {
                selectedFields.push(field);
            }
            
            updateOverview();
        });

        // 更新总体概览
        function updateOverview() {
            const overview = d3.select("#overview");
            overview.selectAll("*").remove();

            // 调试日志：检查 allData
            console.log("allData:", allData);
            if (!allData || allData.length === 0) {
                console.error("allData is empty or undefined");
                return;
            }

            // 全局 x 比例尺，基于所有数据的最大发文量
            const globalMaxTimes = d3.max(allData, d => d.times) || 1;

            // 按 Prize year 倒序分组，并计算每个年份的高度
            const years = [...new Set(allData.map(d => d["Prize year"]))].sort((a, b) => b - a);
            const yearDataMap = new Map();
            let totalHeight = 0;
            years.forEach(year => {
                const yearData = allData.filter(d => d["Prize year"] === year && selectedFields.includes(d.field.toLowerCase()))
                    .sort((a, b) => {
                        const fieldOrder = { physics: 1, chemistry: 2, medicine: 3 };
                        return fieldOrder[a.field.toLowerCase()] - fieldOrder[b.field.toLowerCase()];
                    });
                if (yearData.length > 0) {
                    yearDataMap.set(year, { data: yearData, yOffset: totalHeight });
                    totalHeight += yearData.length * 25 + 30; // 调整行高和间距
                }
            });

            // 创建一个大的 SVG 包含整个时间轴和柱子
            const svg = overview.append("svg")
                .attr("width", "100%")
                .attr("height", totalHeight);

            const margin = {top: 10, right: 50, bottom: 10, left: 220};
            const width = svg.node().clientWidth - margin.left - margin.right;

            const x = d3.scaleLinear()
                .domain([0, globalMaxTimes])
                .range([0, width]);

            // 绘制时间轴
            const timelineG = svg.append("g")
                .attr("transform", `translate(50, 0)`);

            timelineG.append("line")
                .attr("x1", 0)
                .attr("y1", 10)
                .attr("x2", 0)
                .attr("y2", totalHeight - 10)
                .attr("stroke", "#ffffff")
                .attr("stroke-width", 4);

            // 绘制年份和柱子
            yearDataMap.forEach((value, year) => {
                const yearData = value.data;
                const yOffset = value.yOffset;

                // 调试日志：检查 yearData 和 ranks
                console.log(`Year ${year} data:`, yearData);
                yearData.forEach(d => {
                    let ranks = d["prize_paper_ranks"] || (d["prize_paper_rank"] ? [d["prize_paper_rank"]] : []);
                    console.log(`Ranks for ${d["Laureate name"]}:`, ranks);
                });

                // 绘制年份标记
                timelineG.append("circle")
                    .attr("cx", 0)
                    .attr("cy", yOffset + 10)
                    .attr("r", 5)
                    .attr("fill", "#ffcc00");

                timelineG.append("text")
                    .attr("class", "year-title")
                    .attr("x", -40)
                    .attr("y", yOffset + 14)
                    .attr("text-anchor", "end")
                    .attr("fill", "#ffffff")
                    .text(year);

                // 绘制柱子和亮点
                const g = svg.append("g")
                    .attr("transform", `translate(${margin.left},${yOffset})`);

                const height = yearData.length * 25; // 调整行高
                const y = d3.scaleBand()
                    .domain(yearData.map(d => d["Laureate name"]))
                    .range([0, height])
                    .padding(0.4);

                g.selectAll(".bar")
                    .data(yearData)
                    .enter()
                    .append("rect")
                    .attr("class", "bar")
                    .attr("x", 0)
                    .attr("y", d => y(d["Laureate name"]))
                    .attr("width", 0)
                    .attr("height", 8)
                    .attr("rx", 3)
                    .attr("ry", 3)
                    .attr("fill", d => d.field === "chemistry" ? "#ffcc00" : d.field === "physics" ? "#00ccff" : "#ff6666")
                    .transition()
                    .duration(500)
                    .ease(d3.easeCubicOut)
                    .attr("width", d => x(d.times));

                // 添加亮点（支持多个获奖论文）
                const highlightData = yearData.flatMap(d => {
                    let ranks = d["prize_paper_ranks"] || (d["prize_paper_rank"] ? [d["prize_paper_rank"]] : []);
                    return ranks.map(rank => ({
                        rank: rank,
                        times: d.times,
                        laureateName: d["Laureate name"]
                    }));
                });

                g.selectAll(".highlight")
                    .data(highlightData)
                    .enter()
                    .append("image")
                    .attr("class", "highlight")
                    .attr("xlink:href", "./nobel.png")
                    .attr("x", d => {
                        const cx = x(d.rank / d.times * d.times);
                        return cx - 5;
                    })
                    .attr("y", d => {
                        const cy = y(d.laureateName) + 2;
                        return cy - 5;
                    })
                    .attr("width", 0)
                    .attr("height", 0)
                    .transition()
                    .duration(500)
                    .ease(d3.easeCubicOut)
                    .attr("width", 15)
                    .attr("height", 15);

                g.selectAll(".label")
                    .data(yearData)
                    .enter()
                    .append("text")
                    .attr("class", "label")
                    .attr("x", -20)
                    .attr("y", d => y(d["Laureate name"]) + 5)
                    .attr("text-anchor", "end")
                    .attr("fill", "#ffffff")
                    .attr("font-family", "'Times New Roman', Times, serif")
                    .attr("font-size", "16px")
                    .attr("font-weight", "bold")
                    .text(d => d["Laureate name"]);

                g.selectAll(".bar")
                    .on("mouseover", function(event, d) {
                        d3.select(".tooltip")
                            .style("display", "block")
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 10) + "px")
                            .html(`<span style="font-family: 'Microsoft YaHei', 'Heiti SC', '黑体', Arial, sans-serif;">${d["Laureate name"]}</span><br><span style="font-family: 'SimSun', 'Times New Roman', Times, serif;">总发文量: ${d.times} 篇<br>获奖年份: ${d["Prize year"]}<br>获奖论文: 第 ${(d["prize_paper_ranks"] || (d["prize_paper_rank"] ? [d["prize_paper_rank"]] : [])).length > 0 ? (d["prize_paper_ranks"] || [d["prize_paper_rank"]]).join('、') : '无'} 篇</span>`);
                    })
                    .on("mouseout", function() {
                        d3.select(".tooltip").style("display", "none");
                    })
                    .on("click", function(event, d) {
                        showDetail(d["Laureate name"], d.field);
                    });
            });
        }

        // 显示科学家详情
        function showDetail(laureateName, field) {
            d3.select(".overview").transition().duration(300).style("opacity", 0).on("end", function() {
                d3.select(".overview").style("display", "none");
                d3.select(".detail").classed("active", true);
            });

            const scientistTimeline = timelineData.filter(d => d["Laureate name"] === laureateName && d.field === field);
            console.log("Scientist Timeline:", scientistTimeline);

            if (!scientistTimeline || scientistTimeline.length === 0) {
                console.error("No timeline data found for", laureateName, field);
                return;
            }

            // 获取获奖论文位置和获奖年份
            const scientistData = allData.find(d => d["Laureate name"] === laureateName && d.field === field);
            const prizePaperRanks = scientistData ? (scientistData["prize_paper_ranks"] || (scientistData["prize_paper_rank"] ? [scientistData["prize_paper_rank"]] : [])) : [];
            const prizeYear = scientistData ? scientistData["Prize year"] : null;

            // 按年份排序，映射获奖论文年份
            const sortedTimeline = [...scientistTimeline].sort((a, b) => a["Pub year"] - b["Pub year"]);
            let paperCount = 0;
            const prizePaperYears = [];
            sortedTimeline.forEach((d, index) => {
                paperCount += d.times;
                if (prizePaperRanks.includes(paperCount)) {
                    prizePaperYears.push(d["Pub year"]);
                }
            });
            console.log("Prize Paper Years:", prizePaperYears);
            console.log("Prize Year:", prizeYear);

            const svg = d3.select("#detail-svg");
            svg.selectAll("*").remove();
            console.log("SVG Dimensions:", { width: svg.node().clientWidth, height: svg.node().clientHeight });

            const margin = {top: 100, right: 20, bottom: 50, left: 480};
            const width = svg.node().clientWidth - margin.left - margin.right;
            const height = svg.node().clientHeight - margin.top - margin.bottom;
            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            const years = scientistTimeline.map(d => d["Pub year"]);
            const x = d3.scaleLinear()
                .domain([d3.min(years), d3.max(years)])
                .range([0, width]);

            const y = d3.scaleLinear()
                .domain([0, d3.max(scientistTimeline, d => d.times) || 1])
                .range([height, 0]);

            console.log("X Domain:", [d3.min(years), d3.max(years)]);
            console.log("Y Domain:", [0, d3.max(scientistTimeline, d => d.times)]);

            g.append("g")
                .attr("transform", `translate(0,${height})`)
                .attr("class", "axis")
                .call(d3.axisBottom(x).ticks(Math.min(years.length, 10)).tickFormat(d3.format("d")));

            g.append("g")
                .attr("class", "axis")
                .call(d3.axisLeft(y).ticks(Math.min(5, d3.max(scientistTimeline, d => d.times))).tickFormat(d3.format("d")));

            const line = d3.line()
                .x(d => x(d["Pub year"]))
                .y(d => y(d.times));

            const path = g.append("path")
                .datum(scientistTimeline)
                .attr("fill", "none")
                .attr("stroke", "#ffffff")
                .attr("stroke-width", 4)
                .attr("d", line);

            const totalLength = path.node().getTotalLength();
            path
                .attr("stroke-dasharray", totalLength + " " + totalLength)
                .attr("stroke-dashoffset", totalLength)
                .transition()
                .duration(500)
                .ease(d3.easeLinear)
                .attr("stroke-dashoffset", 0);

            g.selectAll(".dot")
                .data(scientistTimeline)
                .enter()
                .append("circle")
                .attr("class", "dot")
                .attr("cx", d => x(d["Pub year"]))
                .attr("cy", d => y(d.times))
                .attr("r", 0)
                .attr("fill", "#ffcc00")
                .transition()
                .duration(500)
                .delay((d, i) => i * 50)
                .attr("r", 4);

            // 标注发表获奖论文的年份（亮点）
            g.selectAll(".prize-paper-dot")
                .data(prizePaperYears)
                .enter()
                .append("circle")
                .attr("class", "prize-paper-dot")
                .attr("cx", d => x(d))
                .attr("cy", d => {
                    const timelineEntry = scientistTimeline.find(entry => entry["Pub year"] === d);
                    return timelineEntry ? y(timelineEntry.times) : y(0);
                })
                .attr("r", 0)
                .attr("fill", "#ffffff")
                .transition()
                .duration(500)
                .delay((d, i) => i * 50)
                .attr("r", 6);

            // 标注获奖年份（nobel.png）
            if (prizeYear) {
                const timelineEntry = scientistTimeline.find(d => d["Pub year"] === prizeYear);
                const yPos = timelineEntry ? y(timelineEntry.times) : y(0);
                g.append("image")
                    .attr("xlink:href", "./nobel.png")
                    .attr("x", x(prizeYear) - 7.5)
                    .attr("y", yPos - 7.5)
                    .attr("width", 0)
                    .attr("height", 0)
                    .transition()
                    .duration(500)
                    .ease(d3.easeCubicOut)
                    .attr("width", 15)
                    .attr("height", 15);
            }
        }

        // 返回概览
// 关闭详情视图
        d3.select("#close-button").on("click", function() {
            d3.select(".detail").classed("active", false);
            d3.select(".overview").style("display", "block").transition().duration(300).style("opacity", 1);
        });
    </script>
</body>
</html>